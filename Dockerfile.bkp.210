
# =========================
# BUILD STAGE (CentOS Stream 9 + JDK 21 + Maven)
# =========================
FROM quay.io/centos/centos:stream9 AS build

# Install JDK 21 + Maven + jmods + binutils (objcopy needed by --strip-debug)
RUN dnf -y --setopt=install_weak_deps=False --nodocs \
       install java-21-openjdk-devel java-21-openjdk-jmods maven tar gzip binutils \
    && dnf clean all && rm -rf /var/cache/dnf

WORKDIR /workspace
COPY . .

# Resolve actual JDK home and symlink to /opt/jdk (stable path)
RUN JDK_DIR="$(dirname "$(dirname "$(readlink -f "$(which javac)")")")" \
 && echo "Resolved JDK_DIR: ${JDK_DIR}" \
 && ln -s "${JDK_DIR}" /opt/jdk

ENV JAVA_HOME=/opt/jdk
ENV PATH="${JAVA_HOME}/bin:${PATH}"

# Optional sanity checks
RUN java -version && javac -version && mvn -version \
 && test -d "${JAVA_HOME}/jmods" && ls -1 "${JAVA_HOME}/jmods" | head -n 10

# Build the app (skip tests for speed)
RUN mvn -B -DskipTests clean package

# ---- Create trimmed Java 21 runtime with jlink ----
# Modules needed by Spring Boot + embedded Tomcat:
# - java.desktop         (java.beans PropertyEditor)
# - java.management      (JMX)
# - java.naming          (JNDI)
# - java.security.jgss   (GSSAPI/Kerberos)
# - java.instrument      (java.lang.instrument*)
# - jdk.unsupported      (Unsafe / internals used by some libs)
# - jdk.crypto.ec        (TLS/ECDSA)
# Add java.sql and java.net.http if your app uses JDBC/HTTP client.
RUN jlink \
    --module-path "${JAVA_HOME}/jmods" \
    --add-modules java.base,java.logging,java.xml,java.desktop,java.management,java.naming,java.security.jgss,java.instrument,jdk.unsupported,jdk.crypto.ec \
    --compress=2 --strip-debug --no-header-files --no-man-pages \
    --output /opt/jre

# Optional: remove Maven cache
RUN rm -rf /root/.m2

# =========================
# RUNTIME STAGE (UBI9-micro)
# =========================
FROM registry.access.redhat.com/ubi9-micro AS runtime

# Custom JRE
COPY --from=build /opt/jre /opt/jre
ENV JAVA_HOME=/opt/jre
ENV PATH="${JAVA_HOME}/bin:${PATH}"

# Create 'appuser' without shadow-utils
RUN mkdir -p /home/appuser \
 && echo 'appuser:x:1001:1001:Application User:/home/appuser:/sbin/nologin' >> /etc/passwd \
 && echo 'appuser:x:1001:' >> /etc/group \
 && chown -R 1001:1001 /home/appuser

WORKDIR /app
COPY --from=build /workspace/target/demo-0.0.1-SNAPSHOT.jar /app/app.jar
RUN chown -R 1001:1001 /app

USER appuser
EXPOSE 8080

ENTRYPOINT ["java","-jar","/app/app.jar"]

